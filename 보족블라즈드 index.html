<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
ss    <title>BLOCK MASTER TNT PERFECT</title>
    <style>
        * { box-sizing: border-box; user-select: none; -webkit-user-select: none; touch-action: none; font-family: 'Malgun Gothic', sans-serif; font-weight: 900; }
        html, body { width: 100%; height: 100%; margin: 0; padding: 0; background-color: #000; overflow: hidden; color: #fff; }
        #bg-layer { position: fixed; inset: 0; z-index: 1; background-size: cover; background-position: center; transition: 0.8s; }
        #bg-overlay { position: fixed; inset: 0; z-index: 2; background: rgba(0,0,0,0.6); }
        .page { position: fixed; inset: 0; display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 10; padding: 10px; }
        #game-container { position: relative; width: 100%; max-width: 480px; aspect-ratio: 480/720; }
        canvas { background: rgba(0,0,0,0.4); border-radius: 20px; border: 2px solid rgba(255,255,255,0.1); width: 100%; height: auto; cursor: crosshair; }
        #score-display { font-size: 60px; color: #ffd700; text-shadow: 0 0 20px rgba(255,215,0,0.6); }
        
        /* Ìè≠ÌÉÑ Î≤ÑÌäº Ïï†ÎãàÎ©îÏù¥ÏÖò Ï∂îÍ∞Ä */
        .tnt-btn { position: absolute; bottom: 8%; right: 5%; width: 75px; height: 75px; background: #ff4757; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 32px; border: 4px solid #fff; z-index: 100; box-shadow: 0 0 20px #ff4757; cursor: pointer; }
        .tnt-btn.active { animation: blink 0.5s infinite alternate; background: #ff0000; border-color: #ffd700; transform: scale(1.1); }
        @keyframes blink { from { box-shadow: 0 0 10px #ff0000; } to { box-shadow: 0 0 30px #ff0000; } }
        
        .menu-btn { width: 100%; max-width: 300px; padding: 14px; margin: 6px 0; border: none; border-radius: 15px; font-size: 19px; color: white; cursor: pointer; text-align: center; }
        .over-box { text-align: center; border: 5px solid #ff4757; padding: 50px; border-radius: 30px; background: #111; }
        @keyframes bump { 0% { transform: scale(1); } 50% { transform: scale(1.15); } 100% { transform: scale(1); } }
        .bump { animation: bump 0.15s ease-out; }
    </style>
</head>
<body>
    <div id="bg-layer"></div>
    <div id="bg-overlay"></div>

    <div id="lobby" class="page" style="display: flex;">
        <h1 style="font-size: 45px; color: #ffd700; text-shadow: 0 5px 15px rgba(255,215,0,0.4);">BLOCK MASTER</h1>
        <div style="background:rgba(255,255,255,0.1); backdrop-filter:blur(10px); padding:15px; border-radius:15px; width: 100%; max-width: 340px; text-align: center; margin-bottom: 15px; border: 1px solid rgba(255,255,255,0.2);">
            üí∞ <span id="gold-val">0</span> | üèÜ <span id="best-val">0</span> | üß® <span id="tnt-total-val">0</span>
        </div>
        <button onclick="buyTNT()" class="menu-btn" style="background:#ff4757; border:2px solid #ffd700;">üß® Ìè≠ÌÉÑ Íµ¨Îß§ (500G)</button>
        <div style="margin: 5px;"></div>
        <button onclick="tryStart('coin')" class="menu-btn" style="background:#FFC107; color:#000;">üí∞ ÏΩîÏù∏ Î™®Îìú</button>
        <button onclick="tryStart('neon')" class="menu-btn" style="background:#E040FB;">üåå ÎÑ§Ïò® Î™®Îìú</button>
        <button onclick="tryStart('jewel')" class="menu-btn" style="background:#00E5FF; color:#000;">üíé Î≥¥ÏÑù Î™®Îìú</button>
        <button onclick="tryStart('mountain')" class="menu-btn" style="background:#4CAF50;">‚õ∞Ô∏è ÏÇ∞ÏïÖ Î™®Îìú</button>
        <button onclick="tryStart('ocean')" class="menu-btn" style="background:#2196F3;">üåä Î∞îÎã§ Î™®Îìú</button>
    </div>

    <div id="game-ui" class="page">
        <div id="game-container">
            <div style="width: 100%; display: flex; justify-content: space-between; align-items: center; padding: 10px;">
                <div onclick="goHome()" style="font-size: 32px; cursor: pointer;">üè†</div>
                <div id="score-display">0</div>
                <div style="font-size: 22px; color:#ff4757; background:rgba(0,0,0,0.5); padding:5px 10px; border-radius:15px;">üß®x<span id="tnt-ingame">0</span></div>
            </div>
            <canvas id="cvs" width="480" height="660"></canvas>
            <div class="tnt-btn" id="tnt-trigger" onclick="toggleTNTMode()">üß®</div>
        </div>
    </div>

    <div id="game-over" class="page">
        <div class="over-box">
            <h1 style="color:#ff4757; font-size: 55px; margin:0;">GAME OVER</h1>
            <p style="font-size: 30px; margin: 20px 0; color: #aaa;">FINAL SCORE</p>
            <div id="final-score" style="font-size: 60px; color: #fff; margin-bottom: 30px;">0</div>
            <button onclick="goHome()" class="menu-btn" style="background:#fff; color:#000; font-size: 24px;">RETRY</button>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('cvs'), ctx = canvas.getContext('2d');
        const scoreEl = document.getElementById('score-display');
        let audioCtx;

        const THEME_IMAGES = {
            coin: "https://images.unsplash.com/photo-1591033594798-33227a05780d?q=80&w=1200",
            neon: "https://images.unsplash.com/photo-1563089145-599997674d42?q=80&w=1200",
            jewel: "https://cdn.pixabay.com/photo/2023/05/13/18/06/opals-7991067_640.jpg", 
            mountain: "https://images.unsplash.com/photo-1464822759023-fed622ff2c3b?q=80&w=1200",
            ocean: "https://images.unsplash.com/photo-1507525428034-b723cf961d3e?q=80&w=1200"
        };

        const COLORS = {
            coin: ['#FFD700', '#FFA000'], neon: ['#00FFFF', '#FF00FF'], jewel: ['#E1F5FE', '#00E5FF'], mountain: ['#4CAF50', '#795548'], ocean: ['#039BE5', '#E1F5FE']
        };

        const SHAPES = [[[1]], [[1,1]], [[1,1,1]], [[1,1],[1,1]], [[1,1,1],[0,1,0]], [[1,1,1,1]], [[1,0],[1,1]], [[1,1,1],[1,0,0]]];

        let state = { 
            active: false, mode: 'coin', score: 0, viewScore: 0, gold: 0, best: 0, tnt: 5, 
            g: Array(8).fill().map(() => Array(8).fill(null)), 
            d: [], drag: null, particles: [],
            tntMode: false, mousePos: {x:0, y:0}
        };

        function playSfx(type) {
            if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const n = audioCtx.currentTime;
            const osc = (freq, dur, vol, wave='sine', sweep=0) => {
                const o = audioCtx.createOscillator(), v = audioCtx.createGain();
                o.type = wave; o.frequency.setValueAtTime(freq, n);
                if(sweep) o.frequency.exponentialRampToValueAtTime(sweep, n + dur);
                v.gain.setValueAtTime(vol, n); v.gain.exponentialRampToValueAtTime(0.01, n + dur);
                o.connect(v); v.connect(audioCtx.destination);
                o.start(); o.stop(n + dur);
            };
            if(type === 'place') {
                osc(state.tntMode ? 2000 : 1000, 0.1, 0.1);
            } else if(type === 'clear' || type === 'boom') {
                osc(150, 0.5, 0.3, 'sawtooth', 40); // ÏõÖÏû•Ìïú Ìè≠Î∞úÏùå
            }
        }

        function drawBlock(x, y, s, c, alpha = 1) {
            ctx.save(); ctx.globalAlpha = alpha;
            if(state.mode === 'coin') {
                ctx.fillStyle = c; ctx.beginPath(); ctx.arc(x+s/2, y+s/2, s/2-5, 0, Math.PI*2); ctx.fill();
                ctx.strokeStyle = "#B8860B"; ctx.lineWidth = 2; ctx.stroke();
                ctx.fillStyle = "#B8860B"; ctx.font = `bold ${s/2}px Arial`; ctx.textAlign = "center"; ctx.textBaseline = "middle"; ctx.fillText("$", x+s/2, y+s/2+2);
            } else if(state.mode === 'neon') {
                ctx.shadowBlur = 15; ctx.shadowColor = c;
                ctx.strokeStyle = c; ctx.lineWidth = 4; ctx.strokeRect(x+6, y+6, s-12, s-12);
            } else if(state.mode === 'jewel') {
                ctx.fillStyle = c; ctx.beginPath(); ctx.moveTo(x+s/2, y+8); ctx.lineTo(x+s-8, y+s/2); ctx.lineTo(x+s/2, y+s-8); ctx.lineTo(x+8, y+s/2); ctx.closePath(); ctx.fill();
                ctx.strokeStyle = "#fff"; ctx.stroke();
            } else {
                ctx.fillStyle = c; ctx.fillRect(x+4, y+4, s-8, s-8);
                ctx.strokeStyle = "rgba(255,255,255,0.3)"; ctx.strokeRect(x+6, y+6, s-12, s-12);
            }
            ctx.restore();
        }

        function createParticles(x, y, color) {
            for(let i=0; i<15; i++) state.particles.push({ x, y, color, vx: (Math.random()-0.5)*15, vy: (Math.random()-0.5)*15, life: 1.0, size: Math.random()*5+2 });
        }

        function toggleTNTMode() {
            if(state.tnt <= 0) { alert("üß® Ìè≠ÌÉÑÏù¥ ÏóÜÏäµÎãàÎã§!"); return; }
            state.tntMode = !state.tntMode;
            document.getElementById('tnt-trigger').classList.toggle('active', state.tntMode);
            if(state.tntMode) state.drag = null; // ÎìúÎûòÍ∑∏ Ï∑®ÏÜå
        }

        function useTNT(gx, gy) {
            state.tnt--;
            state.tntMode = false;
            document.getElementById('tnt-trigger').classList.remove('active');
            playSfx('boom');
            
            let blastCount = 0;
            for(let r=gy-1; r<=gy+1; r++) {
                for(let c=gx-1; c<=gx+1; c++) {
                    if(r>=0 && r<8 && c>=0 && c<8) {
                        if(state.g[r][c]) {
                            createParticles(c*60+30, r*60+30, "#ff4757");
                            state.g[r][c] = null;
                            blastCount++;
                        }
                    }
                }
            }
            state.score += blastCount * 50;
            updateUI();
            saveData();
            checkGameOver();
        }

        function mk() {
            const p = COLORS[state.mode];
            state.d = [0,1,2].map(i => ({ s: SHAPES[Math.floor(Math.random()*SHAPES.length)], c: p[Math.floor(Math.random()*p.length)], x: i*145+55, y:530 }));
            checkGameOver();
        }

        function loop() {
            if(!state.active) return;
            ctx.clearRect(0,0,480,660);
            
            // Îã§Îã§Îã• Ï†êÏàò
            if(state.viewScore < state.score) {
                state.viewScore += Math.ceil((state.score - state.viewScore) / 10);
                scoreEl.innerText = state.viewScore;
                scoreEl.classList.add('bump');
            } else { scoreEl.classList.remove('bump'); }

            // Í∑∏Î¶¨Îìú Î∞è Î∏îÎ°ù
            for(let r=0; r<8; r++) for(let c=0; c<8; c++) {
                ctx.fillStyle = "rgba(255,255,255,0.08)"; ctx.fillRect(c*60+1, r*60+1, 58, 58);
                if(state.g[r][c]) drawBlock(c*60, r*60, 60, state.g[r][c]);
            }

            // Ìè≠ÌÉÑ Î™®Îìú Í∞ÄÏù¥Îìú
            if(state.tntMode) {
                const gx = Math.floor(state.mousePos.x/60), gy = Math.floor(state.mousePos.y/60);
                if(gx>=0 && gx<8 && gy>=0 && gy<8 && state.mousePos.y < 480) {
                    ctx.fillStyle = "rgba(255, 71, 87, 0.4)";
                    ctx.fillRect((gx-1)*60, (gy-1)*60, 180, 180);
                    ctx.font = "40px Arial"; ctx.textAlign="center"; ctx.fillText("üß®", state.mousePos.x, state.mousePos.y);
                }
            }

            // ÌååÌã∞ÌÅ¥
            state.particles.forEach((p, i) => { p.x += p.vx; p.y += p.vy; p.life -= 0.03; if(p.life <= 0) state.particles.splice(i, 1); ctx.globalAlpha = p.life; ctx.fillStyle = p.color; ctx.fillRect(p.x, p.y, p.size, p.size); });
            ctx.globalAlpha = 1.0;

            // ÌïòÎã® ÎåÄÍ∏∞ Î∏îÎ°ù
            state.d.forEach(b => { if(b) b.s.forEach((row, r) => row.forEach((v, ci) => { if(v) drawBlock(b.x+ci*25, b.y+r*25, 25, b.c); })); });
            
            // ÎìúÎûòÍ∑∏ Ï§ëÏù∏ Î∏îÎ°ù
            if(state.drag) {
                state.drag.s.forEach((row, r) => row.forEach((v, ci) => { if(v) drawBlock(state.drag.mx-30+ci*60, state.drag.my-120+r*60, 60, state.drag.c, 0.7); }));
            }

            requestAnimationFrame(loop);
        }

        const handleStart = e => { 
            const p = getPos(e); 
            state.mousePos = p;
            if(state.tntMode) {
                const gx = Math.floor(p.x/60), gy = Math.floor(p.y/60);
                if(gx>=0 && gx<8 && gy>=0 && gy<8 && p.y < 480) {
                    useTNT(gx, gy);
                }
                return;
            }
            if(p.y > 480) {
                state.d.forEach((b, i) => { if(b && Math.abs(p.x-(b.x+35)) < 75) state.drag = {...b, idx: i, mx:p.x, my:p.y}; }); 
            }
        };

        const handleMove = e => { 
            const p = getPos(e); 
            state.mousePos = p;
            if(state.drag) { state.drag.mx = p.x; state.drag.my = p.y; } 
        };

        const handleEnd = () => {
            if(state.drag) {
                const bx = Math.round((state.drag.mx-30)/60), by = Math.round((state.drag.my-120)/60);
                if(canPlace(bx, by, state.drag.s)) {
                    state.drag.s.forEach((row, r) => row.forEach((v, bc) => { if(v) { state.g[by+r][bx+bc] = state.drag.c; createParticles((bx+bc)*60+30, (by+r)*60+30, state.drag.c); } }));
                    state.score += 20; state.d[state.drag.idx] = null; playSfx('place');
                    if(state.d.every(v=>!v)) mk(); else checkGameOver();
                    checkClear();
                }
                state.drag = null;
            }
            saveData();
        };

        function canPlace(bx, by, shape) {
            for(let r=0; r<shape.length; r++) for(let c=0; c<shape[0].length; c++) if(shape[r][c]) {
                if(by+r < 0 || by+r >= 8 || bx+c < 0 || bx+c >= 8 || state.g[by+r][bx+c]) return false;
            }
            return true;
        }

        function checkClear() {
            let rL = [], cL = [];
            for(let r=0; r<8; r++) if(state.g[r].every(v=>v)) rL.push(r);
            for(let c=0; c<8; c++) if(state.g.every(r=>r[c])) cL.push(c);
            if(rL.length+cL.length > 0) {
                playSfx('clear');
                rL.forEach(r => { for(let c=0; c<8; c++) { createParticles(c*60+30, r*60+30, state.g[r][c]); state.g[r][c]=null; } });
                cL.forEach(c => { for(let r=0; r<8; r++) { if(state.g[r][c]) createParticles(c*60+30, r*60+30, state.g[r][c]); state.g[r][c]=null; } });
                state.score += (rL.length+cL.length)*200; state.gold += (rL.length+cL.length)*30; updateUI();
            }
        }

        canvas.addEventListener('touchstart', e => { e.preventDefault(); handleStart(e); });
        canvas.addEventListener('mousedown', handleStart);
        window.addEventListener('touchmove', e => { e.preventDefault(); handleMove(e); });
        window.addEventListener('mousemove', handleMove);
        window.addEventListener('touchend', handleEnd);
        window.addEventListener('mouseup', handleEnd);
        
        function buyTNT() { if (state.gold >= 500) { state.gold -= 500; state.tnt += 1; updateUI(); saveData(); alert("üß® Ìè≠ÌÉÑ Íµ¨Îß§ ÏôÑÎ£å!"); } else { alert("üí∞ Í≥®ÎìúÍ∞Ä Î∂ÄÏ°±Ìï©ÎãàÎã§!"); } }
        function getPos(e) { const rect = canvas.getBoundingClientRect(); const cx = e.touches ? e.touches[0].clientX : e.clientX; const cy = e.touches ? e.touches[0].clientY : e.clientY; return { x: (cx - rect.left) * (480 / rect.width), y: (cy - rect.top) * (660 / rect.height) }; }
        function gameOver() { state.active = false; document.getElementById('game-over').style.display = 'flex'; document.getElementById('final-score').innerText = state.score; }
        function tryStart(m) { state.mode = m; state.active = true; state.score = 0; state.viewScore = 0; state.g = Array(8).fill().map(() => Array(8).fill(null)); document.getElementById('lobby').style.display = 'none'; document.getElementById('game-ui').style.display = 'flex'; document.getElementById('bg-layer').style.backgroundImage = `url('${THEME_IMAGES[m]}')`; updateUI(); mk(); loop(); }
        function goHome() { state.active = false; state.tntMode = false; document.getElementById('lobby').style.display = 'flex'; document.getElementById('game-ui').style.display = 'none'; document.getElementById('game-over').style.display = 'none'; }
        function updateUI() { document.getElementById('gold-val').innerText = state.gold; document.getElementById('best-val').innerText = state.best; document.getElementById('tnt-total-val').innerText = state.tnt; document.getElementById('tnt-ingame').innerText = state.tnt; }
        function loadData() { const s = localStorage.getItem('bm_v_tnt_click'); if(s) { const d = JSON.parse(s); state.best = d.best||0; state.gold = d.gold||0; state.tnt = d.tnt||5; } updateUI(); }
        function saveData() { if(state.score > state.best) state.best = state.score; localStorage.setItem('bm_v_tnt_click', JSON.stringify({best: state.best, gold: state.gold, tnt: state.tnt})); }
        function checkGameOver() { const p = state.d.some(b => { if(!b) return false; for(let r=0; r<8; r++) for(let c=0; c<8; c++) if(canPlace(c, r, b.s)) return true; return false; }); if(!p && state.d.some(v => v !== null)) setTimeout(() => { if(state.active) gameOver(); }, 1000); }
        window.onload = loadData;
    </script>
</body>
</html>
